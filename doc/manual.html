<!DOCTYPE html>
<html lang="en">
  <head>
    <title>The D2RQ Platform v0.8 - User Manual</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div class="document-collection">This document is part of the <a href="http://d2rq.org/">D2RQ documentation</a>.</div>
    <h1>The D2RQ Platform v0.8 - Treating Relational Databases as Virtual RDF Graphs</h1>
    <h2 id="doctype">User Manual</h2>
    <dl>
      <dt>Authors:</dt>
      <dd><a href="http://richard.cyganiak.de/">Richard Cyganiak</a> (DERI, NUI Galway, Ireland)</dd>
      <dd><a href="http://www.wiwiss.fu-berlin.de/en/institute/pwo/bizer/team/BizerChristian.html">Chris Bizer</a> (Freie Universit&auml;t Berlin, Germany)</dd>
      <dd><a href="http://www.wiwiss.fu-berlin.de/suhl/ueber_uns/team/Joerg_Garbers.htm">J&ouml;rg Garbers</a> (Freie Universit&auml;t Berlin, Germany)</dd>
      <dd><a href="http://www.oliver-maresch.de/">Oliver Maresch</a> (Technische Universit&auml;t Berlin, Germany)</dd>
      <dd><a href="http://beckr.org/">Christian Becker</a> (Freie Universit&auml;t Berlin, Germany)</dd>
    </dl>


<h2 id="abstract">Abstract</h2>

<p>As Semantic Web technologies are getting mature, there is a growing need for 
  RDF applications to access the content of huge, live, non-RDF, legacy databases 
  without having to replicate the whole database into RDF. This document describes 
  the D2RQ Platform that enables
  applications to access these graphs through the
  <a href="http://jena.sourceforge.net/">Jena</a> API,
  as well as over the Web via the
  <a href="http://www.w3.org/TR/rdf-sparql-protocol/">SPARQL Protocol</a> and as
  <a href="http://en.wikipedia.org/wiki/Linked_Data">Linked Data</a>.</p>


<h2 id="toc">Table of Contents</h2>

<ul class="toc">
  <li>1. <a href="#introduction">Introduction</a></li>
  <li>2. <a href="#architecture">The D2RQ Platform</a></li>
  <li>3. <a href="#compatibility">Database Compatibility</a></li>
  <li>4. <a href="#commandline">The Command Line Tools</a>
    <ul>
      <li>4.1. <a href="#generatemapping">Auto-Generating Mapping Files</a></li>
      <li>4.2. <a href="#dumprdf">Dumping the Database to an RDF File</a></li>
    </ul>
  </li>
  <li>5. <a href="#jena">Using D2RQ within Jena</a>
    <ul>
      <li>5.1. <a href="#usingmodel">Using Jena's Model API</a></li>
      <li>5.2. <a href="#usingfind">Using Jena's Graph API</a></li>
      <li>5.3. <a href="#sparql">Using SPARQL</a></li>
      <li>5.4. <a href="#jena-assembler">The D2RQ Assembler</a></li>
      <li>5.5. <a href="#unit-tests">Running the D2RQ unit tests</a></li>
    </ul>
  </li>
</ul>

<hr />


<h2 id="introduction">1. Introduction</h2>

<p>This document describes the D2RQ Platform for accessing 
  non-RDF, relational databases as virtual, read-only RDF graphs.  D2RQ offers a variety of different RDF-based access mechanisms 
  to the content of huge, non-RDF databases without having to replicate the database 
  into RDF.</p>

<p>Using D2RQ you can:</p>
<ul>
  <li>query a non-RDF database using <a href="http://www.w3.org/TR/rdf-sparql-query/">SPARQL</a> or find(spo) queries,</li>
  <li>access information in a non-RDF database using the <a href="http://jena.sourceforge.net/">Jena</a> API,</li>
  <li>access the content of the database as <a href="http://en.wikipedia.org/wiki/Linked_Data">Linked Data</a> over the Web,</li>
  <li>ask <a href="http://www.w3.org/TR/rdf-sparql-query/">SPARQL</a> queries over the <a href="http://www.w3.org/TR/rdf-sparql-protocol/">SPARQL Protocol</a> against the database. </li>
</ul>


<h2 id="architecture">2. The D2RQ Platform</h2>

<p>The D2RQ Platform consists of:</p>
<ul>
  <li>the <strong>D2RQ Mapping Language</strong>, a declarative mapping language 
    for describing the relation between an ontology and an relational data model. 
  </li>
  <li>the <strong>D2RQ Engine</strong>, a plug-in for the Jena Semantic Web toolkit, 
    which uses the mappings to rewrite Jena API calls to SQL queries against the database and passes 
    query results  up to the higher layers of the frameworks.</li>
  <li><strong>D2R Server</strong>, an HTTP server that can be used to provide a Linked Data view, a HTML view for debugging and a SPARQL Protocol endpoint over the database.</li>
</ul>

<p>The figure below depicts the architecture of the D2RQ Platform: </p>
<p><img src="images/architecture.png" alt="D2RQ Platform architecture diagram" /></p>
<p>The <strong>D2RQ Engine</strong> is implemented as a Jena graph, the basic information representation object within the Jena framework. A D2RQ graph wraps a local relational databases into a virtual, read-only RDF graph. It rewrites Jena API calls, find() and SPARQL queries to application-data-model specific SQL queries. The result sets of these SQL queries are transformed into RDF triples or SPARQL result sets that are passed up to the higher layers of the framework.</p>
<p><strong>D2R Server</strong> is a tool for publishing relational databases on the Semantic Web. It enables RDF and HTML browsers to navigate the content of the database, 
and allows applications to query the database using the SPARQL query language. D2R Server builds on the D2RQ Engine. For detailed information on how to set up D2R Server please refer to the 
separate <a href="http://www4.wiwiss.fu-berlin.de/bizer/d2r-server/">D2R Server website</a>. </p>
<p>&nbsp;</p>
<p><strong>Example</strong></p>
<p>We are using an example database which stores information about conferences, 
  papers, authors and topics throughout this manual. The database is mapped to the 
  International Semantic Web Community (ISWC) Ontology.</p>
<ul>
  <li>ISWC D2RQ mapping file: <a href="../example/mapping-iswc.ttl">mapping-iswc.ttl</a></li>
  <li>Example database (with some entries from the ISWC 2002 conference):
    <a href="../example/iswc-mysql.sql">iswc-mysql.sql</a> (MySQL dump)</li>
  <li>ISWC ontology: <a href="http://annotation.semanticweb.org/iswc/iswc.daml">iswc.daml</a></li>
</ul>


<h2 id="compatibility">3. Database Compatibility</h2>

<p>The D2RQ Plaffrom has been tested with these database engines:</p>

<dl>
<dt>Oracle</dt>
<dd>Works with Oracle.</dd>

<dt>MySQL</dt>
<dd>Works with MySQL.</dd>

<dt>PostgreSQL</dt>
<dd>Works with PostgreSQL.</dd>

<dt>Microsoft SQL Server</dt>
<dd>Works with Microsoft SQL Server.</dd>

<dt>Other SQL-92 compatible databases</dt>
<dd>By default, D2RQ will interact with the database using the SQL-92 standard.
  Any compatible database <em>should</em> work out of the box.</dd>

<dt>Other databases</dt>
<dd>Not tested; may or may not work. We are interested in feedback about D2RQ running with other database engines.</dd>

<dt>ODBC data sources (e.g. Microsoft Access)</dt>
<dd>D2RQ can connect to ODBC data sources by using an ODBC-JDBC bridge. This works
  with the following limitations:
  <ul>
  <li>The mapping generator does not work.</li>
  <li>The automatic detection of column types does not work. Therefore, column types
    for <em>all</em> database columns must be provided in the mapping file
    by adding <code>d2rq:textColumn</code>,
    <code>d2rq:numericColumn</code>, <code>d2rq:dateColumn</code> or
    <code>d2rq:timestampColumn</code> statements to the <code>d2rq:Database</code>.</li>
  </ul>
  If possible, a dedicated JDBC driver for the database engine should be used
  instead of an ODBC-JDBC bridge to avoid these problems.
</dd>

</dl>


<h2 id="commandline">4. The Command Line Tools</h2>

<p>The D2RQ Platform comes with
two command line tools: a mapping generator that creates a default mapping file
by analyzing the schema of an existing database, and a dump script that writes
the complete contents of a database into a single RDF file. The scripts work
on Windows and Unix systems.</p>

<h3 id="generatemapping">4.1 Auto-generate Mapping Files</h3>

<p>The <code>generate-mapping</code> script creates a default mapping file by
analyzing the schema of an existing database. This mapping file can be used
as-is or can be customized.</p>

<pre>generate-mapping [-u username] [-p password] [-d driverclass] [-o outfile.ttl] [-b base uri] jdbcURL</pre>

<dl>
<dt>jdbcURL</dt>
<dd><p>JDBC connection URL for the database. Refer to your JDBC driver documentation
for the format for your database engine. Examples:</p>
<p>MySQL: <code>jdbc:mysql://<em>servername</em>/<em>databasename</em></code><br />
PostgreSQL: <code>jdbc:postgresql://<em>servername</em>/<em>databasename</em></code><br />
Oracle: <code>jdbc:oracle:thin:@<em>servername</em>:1521:<em>databasename</em></code><br />
Microsoft SQL Server: <code>jdbc:sqlserver://<em>servername</em>;databaseName=<em>databasename</em></code> (due to the semicolon, the URL must be put in quotes when passed as a command-line argument in Linux/Unix shells)</p>
</dd>

<dt>-u username</dt>
<dd>The login name of the database user</dd>

<dt>-p password</dt>
<dd>The password of the database user</dd>

<dt>-d driverclass</dt>
<dd><p>The fully qualified Java class name of the database driver. The jar file
containing the JDBC driver has to be in D2RQ's <code>/lib/db-drivers/</code>
directory. Drivers for MySQL and PostgreSQL are provided with the
download, for other databases a driver has to be downloaded from the vendor
or a third party. To find the driver class name, consult the driver
documentation. Examples:</p>
<p>MySQL: <code>com.mysql.jdbc.Driver</code><br />
PostgreSQL: <code>org.postgresql.Driver</code><br />
Oracle: <code>oracle.jdbc.OracleDriver</code><br />
Microsoft SQL Server: <code>com.microsoft.sqlserver.jdbc.SQLServerDriver</code></p>
</dd>

<dt>-o outfile.ttl</dt>
<dd>The generated mapping will be stored in this file in Turtle syntax. If this
parameter is omitted, the mapping will be written to standard out.</dd>

<dt>-b baseURI</dt>
<dd>The base URI is used to construct a vocabulary namespace that will automatically be served
as Linked Data by D2R Server, following the convention <code>http://<em>baseURI</em><strong>/vocab/resource/</strong></code>.  
This should be the same base URI that is used when invoking the server. Defaults to <code>http://localhost:2020/</code>.
For more information on vocabulary serving, see <a href="#servingvocabularies">section 6.4</a>.</dd>
</dl>

<p>Example invocation for a local MySQL database:</p>

<pre>generate-mapping -d com.mysql.jdbc.Driver -u root jdbc:mysql://127.0.0.1/iswc</pre>


<h3 id="dumprdf">4.2 Dumping the Database to an RDF File</h3>

<p>The <code>dump-rdf</code> script provides a way of dumping the contents of the
whole database into a single RDF file. This can be done with or without a
mapping file. If a mapping file is specified, then the script will use it
to translate the database contents to RDF. If no mapping file is specified,
then the script will invoke <code>generate-mapping</code> and use its default
mapping for the translation.</p>

<pre>dump-rdf -m mapping.ttl [output parameters]</pre>

<p>If no mapping file is provided, then the database connection must be
specified on the command line. With the exception of <code>fetchSize</code>, the meaning of all parameters is the
same as for the <a href="#generatemapping"><code>generate-mapping</code> script</a>.

<pre>dump-rdf -u username [-p password] -d driverclass -j jdbcURL [-f fetchSize] [output parameters]</pre>

<p>Several optional parameters control the RDF output:</p>

<dl>
<dt>-f format</dt>
<dd>The RDF syntax to use for output. Supported syntaxes are "RDF/XML" (the default),
  "RDF/XML-ABBREV", "TURTLE", "N3", "N-TRIPLE". "N-TRIPLE" works best for large 
  databases.</dd>
  
<dt>-s fetchSize</dt>
<dd>The number of rows to retrieve with every database request. This value is particularily important to control memory resources of both the D2RQ and the database server when performing dumps. <code>dump-rdf</code> sets this value to 500 by default, or to <code>Integer.MIN_VALUE</code> for MySQL in order to enable <a href="http://dev.mysql.com/doc/refman/5.0/en/connector-j-reference-implementation-notes.html">streaming mode</a>.
This value may alternatively be specified in the mapping using <a href="#database">d2rq:fetchSize</a>.
</dd>  

<dt>-b baseURI</dt>
<dd>A base URI for resolving relative URI patterns.</dd>

<dt>-o outfile</dt>
<dd>Name of the destination file. Defaults to standard output.</dd>
</dl>

<p>Example invocation using a mapping file:</p>

<pre>dump-rdf -m mapping-iswc.ttl -f N-TRIPLE -b http://localhost:2020/ &gt; iswc.nt</pre>


<h2 id="jena">5. Using D2RQ within Jena</h2>

<p>This section describes how the D2RQ Engine is used within the <a href="http://jena.sourceforge.net/">Jena 2 Semantic Web framework</a>. 
</p>
<p><strong>Download</strong></p>
<p>D2RQ can be downloaded from <a href="http://sourceforge.net/projects/d2rq-map/">http://sourceforge.net/projects/d2rq-map/</a></p>
<p><strong>Jena Versions</strong></p>
<p>At the time of writing, the latest Jena release is version 2.4. D2RQ requires
  a more recent custom-built version of Jena, the version that ships with
  <a href="http://jena.sourceforge.net/ARQ/">ARQ 1.4</a>. All required jar files
  are included in the D2RQ distribution. (Jena 2.4 and 2.3 <em>may</em>
  work to some extent.)</p>

<p><strong>Installation</strong></p>
<ol>
<li>Add the <code>d2rq-X.X.jar</code> file from D2RQ's <code>/lib</code> directory to your
  application's classpath.</li>
<li>Add all jar files from the <code>/lib/arq-1.4</code> directory
  to your application's classpath.</li>
<li>Add a JDBC driver for your database to your application's
  classpath. Drivers for some popular databases are found
  in D2RQ's <code>/lib/db-drivers</code> directory.</li>
</ol>

<p><strong>Debugging</strong></p>
<p>D2RQ uses the <a href="http://jakarta.apache.org/commons/logging/">Apache Commons - Logging</a>
  API for logging. To enable D2RQ debug messages, set the log level for logger
  <code>de.fuberlin.wiwiss.d2rq</code> to <code>ALL</code>. An easy way to do this is:
<pre>org.apache.log4j.Logger.getLogger(
        "de.fuberlin.wiwiss.d2rq").setLevel(
                org.apache.log4j.Level.ALL);</pre>


<h3 id="usingmodel">5.1 Using Jena's Model API</h3>

<p>The ModelD2RQ class provides a Jena
<a href="http://jena.sourceforge.net/javadoc/com/hp/hpl/jena/rdf/model/Model.html">Model</a>
view on the data
in a D2RQ-mapped database. The example shows how a ModelD2RQ is set up
using a mapping file, and how Jena API calls are used to extract
information about papers and their authors from the model.</p>

<p>The ISWC and FOAF classes have been created with Jena's
<a href="http://jena.sourceforge.net/how-to/schemagen.html">schemagen</a>
tool. The DC and RDF classes are part of Jena.</p>

<pre>// Set up the ModelD2RQ using a mapping file
Model m = new ModelD2RQ("file:doc/example/mapping-iswc.ttl");

// Find anything with an rdf:type of iswc:InProceedings
StmtIterator paperIt = m.listStatements(null, RDF.type, ISWC.InProceedings);

// List found papers and print their titles
while (paperIt.hasNext()) {
    Resource paper = paperIt.nextStatement().getSubject();
    System.out.println("Paper: " + paper.getProperty(DC.title).getString());

    // List authors of the paper and print their names
    StmtIterator authorIt = paper.listProperties(DC.creator);
    while (authorIt.hasNext()) {
        Resource author = authorIt.nextStatement().getResource();
        System.out.println("Author: " + author.getProperty(FOAF.name).getString());
    }
    System.out.println();
}</pre>


<h3 id="usingfind">5.2 Using Jena's Graph API</h3>

<p>In some situations, it is better to use Jena's low-level
<a href="http://jena.sourceforge.net/javadoc/com/hp/hpl/jena/graph/Graph.html">Graph</a>
API instead of the Model API. D2RQ provides an implementation
of the Graph interface, the GraphD2RQ.</p>

<p>The following example shows how the Graph API is used to find all papers
that have been published in 2003.</p>

<pre>// Load mapping file
Model mapping = FileManager.get().loadModel("doc/example/mapping-iswc.ttl");

// Set up the GraphD2RQ
GraphD2RQ g = new GraphD2RQ(mapping, "http://localhost:2020/");

// Create a find(spo) pattern 
Node subject = Node.ANY;
Node predicate = DC.date.asNode();
Node object = Node.createLiteral("2003", null, XSDDatatype.XSDgYear);
Triple pattern = new Triple(subject, predicate, object);

// Query the graph
Iterator it = g.find(pattern);

// Output query results
while (it.hasNext()) {
    Triple t = (Triple) it.next();
    System.out.println("Published in 2003: " + t.getSubject());
}</pre>


<h4 id="cachinggraph">5.2.1 The CachingGraphD2RQ</h4>

<p>In addition to the GraphD2RQ, there is a CachingGraphD2RQ which supports
the same API and uses a LRU cache to remember a number of recent query
results. This will improve performance for repeated queries, but will
report inconsistent results if the database is updated during the lifetime
of the CachingGraphD2RQ.</p>


<h3 id="sparql">5.3 Using SPARQL</h3>

<p>D2RQ can answer SPARQL queries against a D2RQ model. The SPARQL queries
are processed by Jena's ARQ query engine. The example shows how a D2RQ model
is set up, how a SPARQL query is executed, and how the results are written
to the console.</p>

<pre>ModelD2RQ m = new ModelD2RQ("file:doc/example/mapping-iswc.ttl");
String sparql = 
    "PREFIX dc: &lt;http://purl.org/dc/elements/1.1/>" +
    "PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/>" +
    "SELECT ?paperTitle ?authorName WHERE {" +
    "    ?paper dc:title ?paperTitle . " +
    "    ?paper dc:creator ?author ." +
    "    ?author foaf:name ?authorName ." +
    "}";
Query q = QueryFactory.create(sparql); 
ResultSet rs = QueryExecutionFactory.create(q, m).execSelect();
while (rs.hasNext()) {
    QuerySolution row = rs.nextSolution();
    System.out.println("Title: " + row.getLiteral("paperTitle").getString());
    System.out.println("Author: " + row.getLiteral("authorName").getString());
}</pre>


<h3 id="jena-assembler">5.4 The D2RQ Assembler</h3>

<p>D2RQ comes with a Jena assembler. Jena assembler specifications are RDF
configuration files that describe how to construct a Jena model. For more
information on Jena assemblers, see the
<a href="http://jena.sourceforge.net/assembler/index.html">Jena Assembler quickstart page</a>.</p>

<p>The following example shows an assembler specification for a D2RQ model:</p>

<pre>@prefix : &lt;#&gt; .
@prefix ja: &lt;http://jena.hpl.hp.com/2005/11/Assembler#&gt; .
@prefix d2rq: &lt;http://www.wiwiss.fu-berlin.de/suhl/bizer/D2RQ/0.1#&gt; .

&lt;&gt; ja:imports d2rq: .

:myModel
  a d2rq:D2RQModel;
  d2rq:mappingFile &lt;mapping-iswc.ttl&gt;;
  d2rq:resourceBaseURI &lt;http://localhost:2020/&gt;;
  .</pre>

<p>D2RQ model specifications support these two properties:

<dl>
  <dt><code>d2rq:mappingFile</code> (required)</dt>
  <dd>The URI of a D2RQ mapping file to use for setting up the model</dd>
  <dt><code>d2rq:resourceBaseURI</code> (optional)<dt>
  <dd>The base URI for turning relative URI patterns into full URIs.
  If not specified, D2RQ will pick an appropriate base URI.</dd>
</dl>

<p>This usage example will create a D2RQ model from a model specification, and write it to the console:</p>

<pre>// Load assembler specification from file
Model assemblerSpec = FileManager.get().loadModel("doc/example/assembler.ttl");

// Get the model resource
Resource modelSpec = assemblerSpec.createResource(assemblerSpec.expandPrefix(":myModel"));

// Assemble a model
Model m = Assembler.general.openModel(modelSpec);

// Write it to System.out
m.write(System.out);</pre>


<h3 id="unit-tests">5.5. Running the D2RQ unit tests</h3>

<p>Some of the D2RQ unit tests are using the ISWC example database from the <code>/doc/example</code> directory of the D2RQ distribution. To run the tests:</p>

<ol>
  <li>Set up a MySQL database and import the database dump from <code>/doc/example/iswc-mysql.sql</code>.</li>
  <li>Change the JDBC database connection string, username and password in <code>/doc/example/mapping-iswc.ttl</code>
    to match your configuration.</li>
  <li>Run the <code>D2RQTestSuite</code> class as a JUnit test.</li>
</ol>

<p>The tests can also be run via the <code>ant test</code> command if
<a href="http://ant.apache.org/">Apache Ant</a> is available.</p>

</body>
</html>
